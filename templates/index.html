<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>토큰포스트 기사 검색 데모</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 40px 20px;
            background: #f8f9fa;
        }

        h2 {
            margin-bottom: 30px;
            font-size: 22px;
            color: #333;
        }

        #questionInput {
            width: 500px;
            max-width: 80%;
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        button {
            margin-left: 10px;
            padding: 10px 18px;
            border: none;
            border-radius: 20px;
            background: #4285f4;
            color: white;
            font-size: 15px;
            cursor: pointer;
            transition: 0.2s;
        }
        button:hover {
            background: #3367d6;
        }

        #result {
            margin-top: 40px;
            width: 100%;
            max-width: 900px;
        }

        ul {
            list-style: none;
            padding: 0;
        }
        li {
            display: flex;
            gap: 20px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        /* ✅ 이미지: 가로 250px 고정, 세로는 비율 유지 */
        li img {
            width: 250px;
            height: auto;
            border-radius: 8px;
            object-fit: contain; /* 이미지 전체 보이게 */
            flex-shrink: 0;
        }

        li div.content {
            flex: 1;
        }
        li b {
            font-size: 18px;
            color: #222;
        }
        li .date {
            margin-top: 5px;
            font-size: 14px;
            color: #666;
        }
        li a {
            color: #4285f4;
            text-decoration: none;
        }
        li a:hover {
            text-decoration: underline;
        }

        /* ✅ 오른쪽 하단 워터마크 */
        .watermark {
            position: fixed;
            bottom: 10px;
            right: 15px;
            font-size: 14px;
            color: rgba(0,0,0,0.4);
            font-style: italic;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <h2>📄 토큰포스트 기사 검색 (테스트)</h2>

    <div style="display:flex; justify-content:center; align-items:center;">
        <input type="text" id="questionInput" placeholder="질문을 입력하세요">
        <button onclick="search()">검색</button>
    </div>

    <div id="result"></div>

    <!-- ✅ 워터마크 -->
    <div class="watermark">Made by JB CHO</div>

    <script>
        // ✅ 날짜 포맷 함수 (YYYY-MM-DD → YYYY년 M월 D일)
        function formatDateKorean(dateStr) {
            if (!dateStr) return "";
            const parts = dateStr.split("-");
            if (parts.length !== 3) return dateStr;

            const year = parts[0];
            const month = String(parseInt(parts[1], 10)); // 앞 0 제거
            const day = String(parseInt(parts[2], 10));   // 앞 0 제거

            return `${year}년 ${month}월 ${day}일`;
        }

        async function search() {
            const question = document.getElementById('questionInput').value;
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '⏳ 검색 중...';

            try {
                const response = await fetch("/search/documents", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ question })
                });

                const data = await response.json();

                if (data.error) {
                    resultDiv.innerHTML = `<p style="color:red;">❌ ${data.error}</p>`;
                    return;
                }

                let html = `<p>🔎 총 ${data.result_count}건 검색됨</p><ul>`;
                for (const [index, doc] of data.documents.entries()) {
                    const safeId = `summary_${index}`;
                    const imageSrc = doc.image_url && doc.image_url.trim() !== "" 
                        ? doc.image_url 
                        : "https://f1.tokenpost.kr/2025/03/i7kr3eqwog.jpg";

                    html += `
                        <li>
                            <img src="${imageSrc}" alt="기사 이미지">
                            <div class="content">
                                <b>${doc.title || "제목 없음"}</b>
                                <div class="date">${formatDateKorean(doc.date)}</div>
                                🧠 정확도: ${doc.accuracy}<br>
                                📝 기자: ${doc.reporter || "없음"}<br>
                                🔗 <a href="${doc.url}" target="_blank">${doc.url}</a><br>
                                <button 
                                    data-content="${encodeURIComponent(doc.content || '')}" 
                                    data-target="${safeId}" 
                                    onclick="summarizeFromButton(this)">요약하기</button>
                                <div id="${safeId}" style="margin-top:5px; color:blue;"></div>
                            </div>
                        </li>`;
                }
                html += '</ul>';
                resultDiv.innerHTML = html;
            } catch (err) {
                resultDiv.innerHTML = `<p style="color:red;">❌ 오류 발생: ${err.message}</p>`;
            }
        }

        function summarizeFromButton(button) {
            const contentEncoded = button.dataset.content;
            const targetId = button.dataset.target;
            summarize(contentEncoded, targetId);
        }

        async function summarize(contentEncoded, targetId) {
            const content = decodeURIComponent(contentEncoded);

            if (!content || content.length < 10) {
                alert("⚠️ 요약할 본문이 없습니다.");
                return;
            }

            const targetDiv = document.getElementById(targetId);
            targetDiv.innerText = "🧠 요약 중...";

            try {
                const response = await fetch("/summarize", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ content })
                });

                const data = await response.json();

                if (data.summary) {
                    // ✅ 타자 효과 + 공백 유지
                    targetDiv.innerHTML = "📄 "; 
                    let i = 0;
                    const text = data.summary;

                    function typeWriter() {
                        if (i < text.length) {
                            const char = text.charAt(i);
                            // 공백은 HTML 엔티티로 변환해서 출력
                            if (char === " ") {
                                targetDiv.innerHTML += "&nbsp;";
                            } else {
                                targetDiv.innerHTML += char;
                            }
                            i++;
                            setTimeout(typeWriter, 20); // 속도 조절 가능
                        }
                    }
                    typeWriter();

                } else {
                    targetDiv.innerText = "❌ 요약 실패";
                }
            } catch (err) {
                targetDiv.innerText = `❌ 요약 중 오류: ${err.message}`;
            }
        }
    </script>
</body>
</html>
