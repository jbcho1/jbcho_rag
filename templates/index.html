<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>í† í°í¬ìŠ¤íŠ¸ ê¸°ì‚¬ ê²€ìƒ‰ ë°ëª¨</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 40px 20px;
            background: #f8f9fa;
        }

        h2 {
            margin-bottom: 30px;
            font-size: 22px;
            color: #333;
        }

        #questionInput {
            width: 500px;
            max-width: 80%;
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        button {
            margin-left: 10px;
            padding: 10px 18px;
            border: none;
            border-radius: 20px;
            background: #4285f4;
            color: white;
            font-size: 15px;
            cursor: pointer;
            transition: 0.2s;
        }
        button:hover {
            background: #3367d6;
        }

        #result {
            margin-top: 40px;
            width: 100%;
            max-width: 900px;
        }

        ul {
            list-style: none;
            padding: 0;
        }
        li {
            display: flex;
            gap: 20px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        /* âœ… ì´ë¯¸ì§€: ê°€ë¡œ 250px ê³ ì •, ì„¸ë¡œëŠ” ë¹„ìœ¨ ìœ ì§€ */
        li img {
            width: 250px;
            height: auto;
            border-radius: 8px;
            object-fit: contain; /* ì´ë¯¸ì§€ ì „ì²´ ë³´ì´ê²Œ */
            flex-shrink: 0;
        }

        li div.content {
            flex: 1;
        }
        li b {
            font-size: 18px;
            color: #222;
        }
        li .date {
            margin-top: 5px;
            font-size: 14px;
            color: #666;
        }
        li a {
            color: #4285f4;
            text-decoration: none;
        }
        li a:hover {
            text-decoration: underline;
        }

        /* âœ… ì˜¤ë¥¸ìª½ í•˜ë‹¨ ì›Œí„°ë§ˆí¬ */
        .watermark {
            position: fixed;
            bottom: 10px;
            right: 15px;
            font-size: 14px;
            color: rgba(0,0,0,0.4);
            font-style: italic;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <h2>ğŸ“„ í† í°í¬ìŠ¤íŠ¸ ê¸°ì‚¬ ê²€ìƒ‰ (í…ŒìŠ¤íŠ¸)</h2>

    <div style="display:flex; justify-content:center; align-items:center;">
        <input type="text" id="questionInput" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”">
        <button onclick="search()">ê²€ìƒ‰</button>
    </div>

    <div id="result"></div>

    <!-- âœ… ì›Œí„°ë§ˆí¬ -->
    <div class="watermark">Made by JB CHO</div>

    <script>
        // âœ… ë‚ ì§œ í¬ë§· í•¨ìˆ˜ (YYYY-MM-DD â†’ YYYYë…„ Mì›” Dì¼)
        function formatDateKorean(dateStr) {
            if (!dateStr) return "";
            const parts = dateStr.split("-");
            if (parts.length !== 3) return dateStr;

            const year = parts[0];
            const month = String(parseInt(parts[1], 10)); // ì• 0 ì œê±°
            const day = String(parseInt(parts[2], 10));   // ì• 0 ì œê±°

            return `${year}ë…„ ${month}ì›” ${day}ì¼`;
        }

        async function search() {
            const question = document.getElementById('questionInput').value;
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = 'â³ ê²€ìƒ‰ ì¤‘...';

            try {
                const response = await fetch("/search/documents", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ question })
                });

                const data = await response.json();

                if (data.error) {
                    resultDiv.innerHTML = `<p style="color:red;">âŒ ${data.error}</p>`;
                    return;
                }

                let html = `<p>ğŸ” ì´ ${data.result_count}ê±´ ê²€ìƒ‰ë¨</p><ul>`;
                for (const [index, doc] of data.documents.entries()) {
                    const safeId = `summary_${index}`;
                    const imageSrc = doc.image_url && doc.image_url.trim() !== "" 
                        ? doc.image_url 
                        : "https://f1.tokenpost.kr/2025/03/i7kr3eqwog.jpg";

                    html += `
                        <li>
                            <img src="${imageSrc}" alt="ê¸°ì‚¬ ì´ë¯¸ì§€">
                            <div class="content">
                                <b>${doc.title || "ì œëª© ì—†ìŒ"}</b>
                                <div class="date">${formatDateKorean(doc.date)}</div>
                                ğŸ§  ì •í™•ë„: ${doc.accuracy}<br>
                                ğŸ“ ê¸°ì: ${doc.reporter || "ì—†ìŒ"}<br>
                                ğŸ”— <a href="${doc.url}" target="_blank">${doc.url}</a><br>
                                <button 
                                    data-content="${encodeURIComponent(doc.content || '')}" 
                                    data-target="${safeId}" 
                                    onclick="summarizeFromButton(this)">ìš”ì•½í•˜ê¸°</button>
                                <div id="${safeId}" style="margin-top:5px; color:blue;"></div>
                            </div>
                        </li>`;
                }
                html += '</ul>';
                resultDiv.innerHTML = html;
            } catch (err) {
                resultDiv.innerHTML = `<p style="color:red;">âŒ ì˜¤ë¥˜ ë°œìƒ: ${err.message}</p>`;
            }
        }

        function summarizeFromButton(button) {
            const contentEncoded = button.dataset.content;
            const targetId = button.dataset.target;
            summarize(contentEncoded, targetId);
        }

        async function summarize(contentEncoded, targetId) {
            const content = decodeURIComponent(contentEncoded);

            if (!content || content.length < 10) {
                alert("âš ï¸ ìš”ì•½í•  ë³¸ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            const targetDiv = document.getElementById(targetId);
            targetDiv.innerText = "ğŸ§  ìš”ì•½ ì¤‘...";

            try {
                const response = await fetch("/summarize", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ content })
                });

                const data = await response.json();

                if (data.summary) {
                    // âœ… íƒ€ì íš¨ê³¼ + ê³µë°± ìœ ì§€
                    targetDiv.innerHTML = "ğŸ“„ "; 
                    let i = 0;
                    const text = data.summary;

                    function typeWriter() {
                        if (i < text.length) {
                            const char = text.charAt(i);
                            // ê³µë°±ì€ HTML ì—”í‹°í‹°ë¡œ ë³€í™˜í•´ì„œ ì¶œë ¥
                            if (char === " ") {
                                targetDiv.innerHTML += "&nbsp;";
                            } else {
                                targetDiv.innerHTML += char;
                            }
                            i++;
                            setTimeout(typeWriter, 20); // ì†ë„ ì¡°ì ˆ ê°€ëŠ¥
                        }
                    }
                    typeWriter();

                } else {
                    targetDiv.innerText = "âŒ ìš”ì•½ ì‹¤íŒ¨";
                }
            } catch (err) {
                targetDiv.innerText = `âŒ ìš”ì•½ ì¤‘ ì˜¤ë¥˜: ${err.message}`;
            }
        }
    </script>
</body>
</html>
